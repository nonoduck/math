<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>直式乘法挑戰 - 高年級進階版</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --bg: #f0f3f6;
        }

        body {
            font-family: "Microsoft JhengHei", sans-serif;
            margin: 0;
            background: var(--bg);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        #header {
            height: 15vh;
            background: var(--dark);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .ctrl-row { margin: 3px; display: flex; align-items: center; gap: 10px; }
        input { width: 80px; font-size: 1.2rem; text-align: center; border-radius: 8px; border: 2px solid #ccc; padding: 5px; }
        
        button {
            padding: 8px 15px; font-size: 1rem; cursor: pointer; border: none; border-radius: 8px;
            transition: 0.2s; font-weight: bold;
        }
        .btn-start { background: var(--success); color: white; }
        .btn-random { background: #9b59b6; color: white; }
        .btn-pause { background: #f39c12; color: white; }
        .btn-mode { background: var(--primary); color: white; }
        .btn-mode.active { outline: 3px solid white; }

        #stage { display: flex; height: 85vh; width: 100vw; position: relative; }

        .player-area {
            flex: 1; position: relative; border-right: 2px solid #ccc;
            display: flex; flex-direction: column; justify-content: flex-end;
        }

        .stats-bar {
            position: absolute; top: 10px; width: 100%; text-align: center;
            font-size: 1.2rem; color: #555; font-weight: bold;
        }

        .math-wrapper {
            display: flex; justify-content: center; align-items: flex-end;
            margin-bottom: 20px;
        }
        .math-table { border-collapse: collapse; font-size: 2.8rem; font-family: 'Consolas', monospace; }
        .math-table td { width: 60px; height: 65px; text-align: center; vertical-align: bottom; }
        .border-bottom { border-bottom: 4px solid #000 !important; }

        .drop-zone {
            width: 50px; height: 55px; background: #fff; border: 2px dashed #999;
            border-radius: 8px; display: flex; justify-content: center; align-items: center; margin: 0 auto;
        }
        .drop-zone.filled { border: 3px solid var(--primary); background: #eef7ff; color: var(--primary); font-weight: bold; }

        .side-pool {
            position: absolute; bottom: 20px; width: 130px; 
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
            background: rgba(255,255,255,0.4); padding: 10px; border-radius: 20px;
        }
        .pool-left { left: 10px; }
        .pool-right { right: 10px; }

        .num-piece {
            width: 50px; height: 50px; background: #fff; border: 3px solid var(--primary);
            border-radius: 12px; display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; font-weight: bold; cursor: grab; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            touch-action: none; z-index: 100;
        }

        .area-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            font-size: 3rem; font-weight: bold; z-index: 500;
        }
        .overlay-error { background: rgba(231, 76, 60, 0.85); color: white; }
        .overlay-pause { background: rgba(236, 240, 241, 0.95); color: #7f8c8d; }

        .dragging { opacity: 0.8; pointer-events: none; position: fixed; z-index: 9999; }
        
        #win-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 5000; color: white;
        }
    </style>
</head>
<body>

<div id="header">
    <div class="ctrl-row">
        <input type="number" id="n1" placeholder="被乘數">
        <span style="font-size: 1.2rem;">×</span>
        <input type="number" id="n2" placeholder="乘數">
        <button class="btn-start" onclick="resetGame()">手動出題</button>
        <button class="btn-random" onclick="generateRandom()">隨機出題</button>
        <button id="pause-btn" class="btn-pause" onclick="togglePause()">開始計時</button>
    </div>
    <div class="ctrl-row">
        <button id="m-single" class="btn-mode active" onclick="switchMode('single')">單人模式</button>
        <button id="m-battle" class="btn-mode" onclick="switchMode('battle')">兩人競賽</button>
    </div>
</div>

<div id="stage">
    <div id="p1-area" class="player-area">
        <div id="p1-stats" class="stats-bar">P1 | 時間: 0s | 錯誤: 0</div>
        <div id="p1-pause" class="area-overlay overlay-pause">準備中</div>
        <div id="p1-error" class="area-overlay overlay-error">數字錯囉！</div>
        <div id="p1-pool-l" class="side-pool pool-left"></div>
        <div id="p1-grid" class="math-wrapper"></div>
        <div id="p1-pool-r" class="side-pool pool-right"></div>
    </div>
    <div id="p2-area" class="player-area" style="display: none;">
        <div id="p2-stats" class="stats-bar">P2 | 時間: 0s | 錯誤: 0</div>
        <div id="p2-pause" class="area-overlay overlay-pause">準備中</div>
        <div id="p2-error" class="area-overlay overlay-error">數字錯囉！</div>
        <div id="p2-pool-l" class="side-pool pool-left"></div>
        <div id="p2-grid" class="math-wrapper"></div>
        <div id="p2-pool-r" class="side-pool pool-right"></div>
    </div>
</div>

<div id="win-screen" onclick="this.style.display='none'">
    <h1 id="win-text" style="font-size: 5rem;">挑戰成功！</h1>
    <p style="font-size: 1.5rem;">(點擊關閉，可檢視直式正確答案)</p>
</div>

<script>
    let mode = 'single';
    let paused = true;
    let timer;
    let state = {
        p1: { time: 0, err: 0, target: {}, current: {}, finished: false },
        p2: { time: 0, err: 0, target: {}, current: {}, finished: false }
    };

    function switchMode(m) {
        mode = m;
        document.getElementById('m-single').classList.toggle('active', m === 'single');
        document.getElementById('m-battle').classList.toggle('active', m === 'battle');
        document.getElementById('p2-area').style.display = m === 'battle' ? 'flex' : 'none';
        resetGame();
    }

    function togglePause() {
        paused = !paused;
        const btn = document.getElementById('pause-btn');
        btn.innerText = paused ? "開始計時" : "暫停計時";
        btn.className = paused ? "btn-pause" : "btn-start";
        updateMasks();

        if (!paused && !timer) {
            timer = setInterval(() => {
                if (!state.p1.finished) state.p1.time++;
                if (mode === 'battle' && !state.p2.finished) state.p2.time++;
                updateStats();
            }, 1000);
        } else if (paused) {
            clearInterval(timer);
            timer = null;
        }
    }

    function updateMasks() {
        document.getElementById('p1-pause').style.display = paused ? 'flex' : 'none';
        if(mode === 'battle') document.getElementById('p2-pause').style.display = paused ? 'flex' : 'none';
    }

    function updateStats() {
        document.getElementById('p1-stats').innerText = `P1 | 時間: ${state.p1.time}s | 錯誤: ${state.p1.err}`;
        if(mode === 'battle') {
            document.getElementById('p2-stats').innerText = `P2 | 時間: ${state.p2.time}s | 錯誤: ${state.p2.err}`;
        }
    }

    // 隨機按鈕：填入隨機數並執行 resetGame
    function generateRandom() {
        const v1 = Math.floor(Math.random() * 899) + 101; // 101-999
        const v2 = Math.floor(Math.random() * 899) + 101; // 101-999
        document.getElementById('n1').value = v1;
        document.getElementById('n2').value = v2;
        resetGame();
    }

    // 開始挑戰按鈕：讀取目前 input 的值，如果沒填才隨機
    function resetGame() {
        clearInterval(timer);
        timer = null;
        paused = true;
        document.getElementById('pause-btn').innerText = "開始計時";
        updateMasks();

        let v1 = parseInt(document.getElementById('n1').value);
        let v2 = parseInt(document.getElementById('n2').value);

        // 如果手動輸入為空，則自動補一組隨機數
        if (isNaN(v1)) { v1 = Math.floor(Math.random() * 899) + 101; document.getElementById('n1').value = v1; }
        if (isNaN(v2)) { v2 = Math.floor(Math.random() * 899) + 101; document.getElementById('n2').value = v2; }

        initPlayer('p1', v1, v2);
        if (mode === 'battle') initPlayer('p2', v1, v2);
        updateStats();
    }

    function initPlayer(p, n1, n2) {
        state[p] = { time: 0, err: 0, target: {}, current: {}, finished: false };
        const { html, answerMap, allDigits } = buildTable(n1, n2);
        document.getElementById(`${p}-grid`).innerHTML = html;
        state[p].target = answerMap;

        const poolL = document.getElementById(`${p}-pool-l`);
        const poolR = document.getElementById(`${p}-pool-r`);
        poolL.innerHTML = ''; poolR.innerHTML = '';
        
        allDigits.sort(() => Math.random() - 0.5).forEach((num, i) => {
            const div = document.createElement('div');
            div.className = 'num-piece';
            div.innerText = num;
            div.id = `${p}-piece-${i}`;
            div.onpointerdown = (e) => startDrag(e, num, p, div.id);
            (i % 2 === 0 ? poolL : poolR).appendChild(div);
        });
    }

    function buildTable(n1, n2) {
        const s1 = n1.toString();
        const s2 = n2.toString();
        const s2Arr = s2.split('').reverse();
        const total = n1 * n2;
        const maxW = total.toString().length + 1;
        const rows = [];
        const answerMap = {};
        const allDigits = [];

        rows.push(s1.padStart(maxW, ' ').split(''));
        rows.push(("×" + s2).padStart(maxW, ' ').split(''));

        // 中間層處理
        if (s2.length > 1) {
            s2Arr.forEach((digit, i) => {
                let res = (parseInt(digit) * n1).toString();
                let rowArr = Array(maxW).fill(' ');
                let chars = res.split('');
                // 對齊：從右往左數第 i 位開始，不補零
                for(let j = 0; j < chars.length; j++) {
                    let pos = maxW - 1 - i - j;
                    if (pos >= 0) rowArr[pos] = chars[chars.length - 1 - j];
                }
                rows.push(rowArr);
            });
        }
        
        rows.push(total.toString().padStart(maxW, ' ').split(''));

        let html = '<table class="math-table">';
        rows.forEach((row, rIdx) => {
            const isLine = (rIdx === 1 || rIdx === rows.length - 2);
            const isAnsArea = (rIdx >= 2);
            html += '<tr>';
            row.forEach((char, cIdx) => {
                const b = isLine ? 'border-bottom' : '';
                if (/\d/.test(char) && isAnsArea) {
                    const id = `c-${rIdx}-${cIdx}`;
                    answerMap[id] = char;
                    allDigits.push(char);
                    html += `<td class="${b}"><div class="drop-zone" id="${id}"></div></td>`;
                } else {
                    html += `<td class="${b}">${char === ' ' ? '' : char}</td>`;
                }
            });
            html += '</tr>';
        });
        html += '</table>';
        return { html, answerMap, allDigits };
    }

    function startDrag(e, num, player, pieceId) {
        if (paused || state[player].finished) return;
        const el = document.getElementById(pieceId);
        const clone = el.cloneNode(true);
        clone.classList.add('dragging');
        document.body.appendChild(clone);
        
        const move = (ev) => {
            clone.style.left = ev.pageX - 25 + 'px';
            clone.style.top = ev.pageY - 25 + 'px';
        };
        move(e);
        el.style.visibility = 'hidden';
        e.target.setPointerCapture(e.pointerId);

        e.target.onpointermove = move;
        e.target.onpointerup = (ev) => {
            clone.style.display = 'none';
            const target = document.elementFromPoint(ev.clientX, ev.clientY);
            clone.style.display = 'flex';
            
            let ok = false;
            if (target && target.classList.contains('drop-zone')) {
                const area = document.getElementById(`${player}-area`);
                if (area.contains(target) && !target.classList.contains('filled')) {
                    if (num.toString() === state[player].target[target.id]) {
                        target.innerText = num;
                        target.classList.add('filled');
                        state[player].current[target.id] = num;
                        el.remove();
                        ok = true;
                        checkWin(player);
                    }
                }
            }
            
            if (!ok) {
                el.style.visibility = 'visible';
                if (target && target.classList.contains('drop-zone')) {
                    flashError(player);
                    state[player].err++;
                    updateStats();
                }
            }
            clone.remove();
        };
    }

    function flashError(p) {
        const errOverlay = document.getElementById(`${p}-error`);
        errOverlay.style.display = 'flex';
        setTimeout(() => errOverlay.style.display = 'none', 800);
    }

    function checkWin(p) {
        if (Object.keys(state[p].target).length === Object.keys(state[p].current).length) {
            state[p].finished = true;
            if (mode === 'single') {
                showWin("挑戰成功！");
            } else if (state.p1.finished && state.p2.finished) {
                const s1 = state.p1.time + state.p1.err * 5;
                const s2 = state.p2.time + state.p2.err * 5;
                showWin(s1 < s2 ? "P1 勝利！" : "P2 勝利！");
            }
        }
    }

    function showWin(txt) {
        clearInterval(timer);
        document.getElementById('win-text').innerText = txt;
        document.getElementById('win-screen').style.display = 'flex';
    }

    // 初始化：先隨機出一題
    generateRandom();
</script>
</body>
</html>

