<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>響應式直式乘法挑戰</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --bg: #f0f3f6;
            /* 定義基礎單位，隨螢幕縮放 */
            --unit: min(6.5vw, 6.5vh, 70px); 
        }

        body {
            font-family: "Microsoft JhengHei", sans-serif;
            margin: 0;
            background: var(--bg);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* 頂部控制區 (高度縮減以利手機顯示) */
        #header {
            height: 18vh;
            background: var(--dark);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            box-sizing: border-box;
        }

        .ctrl-row { margin: 2px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center; }
        
        input { 
            width: 15vw; max-width: 80px; 
            font-size: clamp(1rem, 3vw, 1.4rem); 
            text-align: center; border-radius: 5px; border: none; padding: 4px; 
        }
        
        button {
            padding: 6px 12px; font-size: clamp(0.8rem, 2.5vw, 1.1rem); 
            cursor: pointer; border: none; border-radius: 6px; font-weight: bold;
        }
        .btn-start { background: var(--success); color: white; }
        .btn-pause { background: #f39c12; color: white; }
        .btn-mode { background: var(--primary); color: white; opacity: 0.6; }
        .btn-mode.active { opacity: 1; outline: 2px solid white; }

        /* 主舞台 */
        #stage { display: flex; height: 82vh; width: 100vw; position: relative; }

        .player-area {
            flex: 1; position: relative; border-right: 1px solid #ccc;
            display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: 2vh;
        }

        .stats-bar {
            position: absolute; top: 5px; width: 100%; text-align: center;
            font-size: clamp(0.8rem, 3vw, 1.2rem); color: #555; font-weight: bold;
        }

        /* 響應式直式表格 */
        .math-wrapper {
            display: flex; justify-content: center; align-items: flex-end;
            margin-bottom: 1vh; width: 100%;
        }
        .math-table { border-collapse: collapse; font-family: 'Consolas', monospace; }
        /* 關鍵：使用變數 --unit 控制大小 */
        .math-table td { 
            width: var(--unit); 
            height: calc(var(--unit) * 1.1); 
            text-align: center; 
            font-size: calc(var(--unit) * 0.7);
        }
        .border-bottom { border-bottom: 3px solid #000 !important; }

        .drop-zone {
            width: 85%; height: 85%; background: #fff; border: 1px dashed #999;
            border-radius: 5px; display: flex; justify-content: center; align-items: center; margin: 0 auto;
        }
        .drop-zone.filled { border: 2px solid var(--primary); background: #eef7ff; color: var(--primary); font-weight: bold; }

        /* 側邊數字池：手機版會縮小 */
        .side-pool {
            position: absolute; bottom: 10px; 
            width: calc(var(--unit) * 1.5); 
            display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;
            background: rgba(255,255,255,0.4); padding: 5px; border-radius: 10px;
        }
        .pool-left { left: 5px; }
        .pool-right { right: 5px; }

        .num-piece {
            width: var(--unit); height: var(--unit);
            background: #fff; border: 2px solid var(--primary);
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            font-size: calc(var(--unit) * 0.5); font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); touch-action: none;
        }

        /* 錯誤覆蓋層 */
        .area-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold; z-index: 500; text-align: center;
        }
        .overlay-error { background: rgba(231, 76, 60, 0.9); color: white; }
        .overlay-pause { background: rgba(236, 240, 241, 0.98); color: #7f8c8d; }

        .dragging { opacity: 0.8; pointer-events: none; position: fixed; z-index: 9999; transform: scale(1.2); }
        
        #win-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 5000; color: white; padding: 20px;
        }

        /* 手機直向特殊調整 */
        @media (max-width: 500px) {
            :root { --unit: 8vw; }
            .side-pool { width: 12vw; }
            #header { height: 22vh; }
            #stage { height: 78vh; }
        }
    </style>
</head>
<body>

<div id="header">
    <div class="ctrl-row">
        <input type="number" id="n1" placeholder="被乘數">
        <span>×</span>
        <input type="number" id="n2" placeholder="乘數">
        <button class="btn-start" onclick="resetGame()">出題</button>
        <button id="pause-btn" class="btn-pause" onclick="togglePause()">開始</button>
    </div>
    <div class="ctrl-row">
        <button id="m-single" class="btn-mode active" onclick="switchMode('single')">單人</button>
        <button id="m-battle" class="btn-mode" onclick="switchMode('battle')">競賽</button>
    </div>
</div>

<div id="stage">
    <div id="p1-area" class="player-area">
        <div id="p1-stats" class="stats-bar">P1: 0s | 0 錯</div>
        <div id="p1-pause" class="area-overlay overlay-pause">準備中</div>
        <div id="p1-error" class="area-overlay overlay-error">數字錯囉！</div>
        <div id="p1-pool-l" class="side-pool pool-left"></div>
        <div id="p1-grid" class="math-wrapper"></div>
        <div id="p1-pool-r" class="side-pool pool-right"></div>
    </div>
    <div id="p2-area" class="player-area" style="display: none;">
        <div id="p2-stats" class="stats-bar">P2: 0s | 0 錯</div>
        <div id="p2-pause" class="area-overlay overlay-pause">準備中</div>
        <div id="p2-error" class="area-overlay overlay-error">數字錯囉！</div>
        <div id="p2-pool-l" class="side-pool pool-left"></div>
        <div id="p2-grid" class="math-wrapper"></div>
        <div id="p2-pool-r" class="side-pool pool-right"></div>
    </div>
</div>

<div id="win-screen" onclick="this.style.display='none'">
    <h1 id="win-text">P1 獲勝！</h1>
    <p>點擊返回看答案</p>
</div>

<script>
    let mode = 'single';
    let paused = true;
    let timer;
    let state = {
        p1: { time: 0, err: 0, target: {}, current: {}, finished: false },
        p2: { time: 0, err: 0, target: {}, current: {}, finished: false }
    };

    function switchMode(m) {
        mode = m;
        document.getElementById('m-single').classList.toggle('active', m === 'single');
        document.getElementById('m-battle').classList.toggle('active', m === 'battle');
        document.getElementById('p2-area').style.display = m === 'battle' ? 'flex' : 'none';
        resetGame();
    }

    function togglePause() {
        paused = !paused;
        const btn = document.getElementById('pause-btn');
        btn.innerText = paused ? "開始" : "暫停";
        document.querySelectorAll('.overlay-pause').forEach(el => el.style.display = paused ? 'flex' : 'none');

        if (!paused && !timer) {
            timer = setInterval(() => {
                if (!state.p1.finished) state.p1.time++;
                if (mode === 'battle' && !state.p2.finished) state.p2.time++;
                updateStats();
            }, 1000);
        } else if (paused) {
            clearInterval(timer);
            timer = null;
        }
    }

    function updateStats() {
        document.getElementById('p1-stats').innerText = `P1: ${state.p1.time}s | ${state.p1.err} 錯`;
        if(mode === 'battle') document.getElementById('p2-stats').innerText = `P2: ${state.p2.time}s | ${state.p2.err} 錯`;
    }

    function resetGame() {
        clearInterval(timer);
        timer = null;
        paused = true;
        document.getElementById('pause-btn').innerText = "開始";
        document.querySelectorAll('.overlay-pause').forEach(el => el.style.display = 'flex');

        let v1 = parseInt(document.getElementById('n1').value) || 123;
        let v2 = parseInt(document.getElementById('n2').value) || 45;
        document.getElementById('n1').value = v1;
        document.getElementById('n2').value = v2;

        initPlayer('p1', v1, v2);
        if (mode === 'battle') initPlayer('p2', v1, v2);
        updateStats();
    }

    function initPlayer(p, n1, n2) {
        state[p] = { time: 0, err: 0, target: {}, current: {}, finished: false };
        const { html, answerMap, allDigits } = buildTable(n1, n2);
        document.getElementById(`${p}-grid`).innerHTML = html;
        state[p].target = answerMap;

        const pL = document.getElementById(`${p}-pool-l`), pR = document.getElementById(`${p}-pool-r`);
        pL.innerHTML = ''; pR.innerHTML = '';
        allDigits.sort(() => Math.random() - 0.5).forEach((num, i) => {
            const div = document.createElement('div');
            div.className = 'num-piece';
            div.innerText = num;
            div.onpointerdown = (e) => startDrag(e, num, p, div);
            (i % 2 === 0 ? pL : pR).appendChild(div);
        });
    }

    function buildTable(n1, n2) {
        const s1 = n1.toString(), s2 = n2.toString();
        const s2Arr = s2.split('').reverse(), rows = [], answerMap = {}, allDigits = [];
        const total = n1 * n2, maxW = total.toString().length + 1;

        rows.push(s1.padStart(maxW, ' ').split(''));
        rows.push(("×" + s2).padStart(maxW, ' ').split(''));
        if (s2.length > 1) {
            s2Arr.forEach((digit, i) => {
                let p = (parseInt(digit) * n1).toString() + "0".repeat(i);
                rows.push(p.padStart(maxW, ' ').split(''));
            });
        }
        rows.push(total.toString().padStart(maxW, ' ').split(''));

        let html = '<table class="math-table">';
        rows.forEach((row, rIdx) => {
            const isLine = (rIdx === 1 || rIdx === rows.length - 2);
            html += '<tr>';
            row.forEach((char, cIdx) => {
                const id = `c-${rIdx}-${cIdx}`;
                if (/\d/.test(char) && rIdx >= 2) {
                    answerMap[id] = char;
                    allDigits.push(char);
                    html += `<td class="${isLine?'border-bottom':''}"><div class="drop-zone" id="${p}-${id}"></div></td>`;
                } else {
                    html += `<td class="${isLine?'border-bottom':''}">${char===' '?'':char}</td>`;
                }
            });
            html += '</tr>';
        });
        return { html: html + '</table>', answerMap, allDigits };
    }

    function startDrag(e, num, player, originEl) {
        if (paused || state[player].finished) return;
        const clone = originEl.cloneNode(true);
        clone.classList.add('dragging');
        document.body.appendChild(clone);
        
        const move = (ev) => {
            clone.style.left = ev.pageX - (clone.offsetWidth/2) + 'px';
            clone.style.top = ev.pageY - (clone.offsetHeight/2) + 'px';
        };
        move(e);
        originEl.style.visibility = 'hidden';
        e.target.setPointerCapture(e.pointerId);

        e.target.onpointermove = move;
        e.target.onpointerup = (ev) => {
            clone.style.display = 'none';
            const target = document.elementFromPoint(ev.clientX, ev.clientY);
            clone.style.display = 'flex';
            
            let ok = false;
            if (target && target.classList.contains('drop-zone') && target.id.startsWith(player)) {
                const cellId = target.id.replace(player + '-', '');
                if (num.toString() === state[player].target[cellId] && !target.classList.contains('filled')) {
                    target.innerText = num;
                    target.classList.add('filled');
                    state[player].current[cellId] = num;
                    originEl.remove();
                    ok = true;
                    checkWin(player);
                }
            }
            if (!ok) {
                originEl.style.visibility = 'visible';
                if (target && target.classList.contains('drop-zone')) {
                    flashError(player);
                    state[player].err++;
                    updateStats();
                }
            }
            clone.remove();
        };
    }

    function flashError(p) {
        const el = document.getElementById(`${p}-error`);
        el.style.display = 'flex';
        setTimeout(() => el.style.display = 'none', 800);
    }

    function checkWin(p) {
        if (Object.keys(state[p].target).length === Object.keys(state[p].current).length) {
            state[p].finished = true;
            if (mode === 'single' || (state.p1.finished && state.p2.finished)) {
                clearInterval(timer);
                document.getElementById('win-text').innerText = mode === 'single' ? "完成挑戰！" : ( (state.p1.time + state.p1.err*5 < state.p2.time + state.p2.err*5) ? "P1 勝利！" : "P2 勝利！" );
                document.getElementById('win-screen').style.display = 'flex';
            }
        }
    }
</script>
</body>
</html>
